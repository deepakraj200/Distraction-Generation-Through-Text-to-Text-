<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generated Questions</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-info {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .question-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .options {
            margin-left: 20px;
        }
        .option {
            margin-bottom: 10px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-edit {
            background-color: #2196F3;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-edit:hover {
            background-color: #0b7dda;
        }
        .btn-remove {
            background-color: #f44336;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn-remove:hover {
            background-color: #d32f2f;
        }
        .edit-mode textarea {
            width: 100%;
            min-height: 100px;
            margin-bottom: 10px;
        }
        .edit-mode input {
            width: 90%;
            margin-bottom: 5px;
        }
        .ai-badge {
            display: inline-block;
            background-color: #6c5ce7;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .question-type {
            display: inline-block;
            background-color: #e17055;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .actions-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Generated Questions</h1>
        <div class="ai-badge">AI Generated</div>
        
        <div class="test-info" id="testInfo">
            <h2 id="testName">Test Name</h2>
            <p><strong>Duration:</strong> <span id="duration">0</span> minutes</p>
            <p><strong>Questions:</strong> <span id="questionCount">0</span></p>
            <p><strong>Source Material:</strong> <span id="fileName">file.pdf</span></p>
        </div>
        
        <div id="questionsContainer">
            <!-- Questions will be populated here -->
        </div>
        
        <div class="actions-bar">
            <button id="regenerateBtn" class="btn" style="background-color: #2196F3;">Regenerate Questions</button>
            <button id="uploadTestBtn" class="btn">Upload Test</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Retrieve test data from sessionStorage
            const testData = JSON.parse(sessionStorage.getItem('newTestData') || '{}');
            
            // Populate test information
            document.getElementById('testName').textContent = testData.testName || 'New Test';
            document.getElementById('duration').textContent = testData.duration || '30';
            document.getElementById('fileName').textContent = testData.fileName || 'No file';
            
            // Generate AI questions based on the PDF content
            generateAIQuestions();
            
            // Handle regenerate button click
            document.getElementById('regenerateBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to regenerate all questions? Any edits will be lost.')) {
                    generateAIQuestions();
                }
            });
            
            // Handle upload button click
            document.getElementById('uploadTestBtn').addEventListener('click', function() {
                uploadTest();
            });
        });
        
        function generateAIQuestions() {
            const questionsContainer = document.getElementById('questionsContainer');
            
            // Clear existing questions
            questionsContainer.innerHTML = '<p>Generating questions from your PDF...</p>';
            
            // In a real implementation, this would make an API call to an AI service
            // For demonstration, we'll simulate AI-generated questions after a short delay
            setTimeout(() => {
                // Clear loading message
                questionsContainer.innerHTML = '';
                
                // Generate a random number of questions (between 15-25)
                const questionCount = Math.floor(Math.random() * 11) + 15;
                document.getElementById('questionCount').textContent = questionCount;
                
                // Sample question types
                const questionTypes = ['multiple-choice', 'true-false', 'fill-in-blank'];
                
                // Generate questions
                for (let i = 1; i <= questionCount; i++) {
                    const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
                    const questionElement = createQuestionElement(i, questionType);
                    questionsContainer.appendChild(questionElement);
                }
            }, 1500);
        }
        
        function createQuestionElement(number, type) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-container';
            questionDiv.dataset.number = number;
            questionDiv.dataset.type = type;
            
            // Create question header
            const questionHeader = document.createElement('div');
            questionHeader.className = 'question-header';
            
            const questionNumber = document.createElement('h3');
            questionNumber.textContent = `Question ${number}`;
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'question-type';
            typeSpan.textContent = type.replace('-', ' ');
            questionNumber.appendChild(typeSpan);
            
            const buttonContainer = document.createElement('div');
            
            const editButton = document.createElement('button');
            editButton.className = 'btn-edit';
            editButton.textContent = 'Edit';
            editButton.addEventListener('click', function() {
                toggleEditMode(questionDiv);
            });
            
            const removeButton = document.createElement('button');
            removeButton.className = 'btn-remove';
            removeButton.textContent = 'Remove';
            removeButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to remove this question?')) {
                    questionDiv.remove();
                    updateQuestionNumbers();
                }
            });
            
            buttonContainer.appendChild(editButton);
            buttonContainer.appendChild(removeButton);
            
            questionHeader.appendChild(questionNumber);
            questionHeader.appendChild(buttonContainer);
            questionDiv.appendChild(questionHeader);
            
            // Generate question content based on type
            const questionContent = generateAIQuestionContent(type);
            
            // Create question text
            const questionText = document.createElement('p');
            questionText.className = 'question-text';
            questionText.textContent = questionContent.question;
            questionDiv.appendChild(questionText);
            
            // Create options
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';
            
            if (type === 'multiple-choice') {
                questionContent.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';
                    
                    const optionInput = document.createElement('input');
                    optionInput.type = 'radio';
                    optionInput.name = `question${number}`;
                    optionInput.id = `q${number}option${index}`;
                    optionInput.value = index;
                    if (index === questionContent.correctAnswer) {
                        optionInput.checked = true;
                        optionInput.dataset.correct = 'true';
                    }
                    
                    const optionLabel = document.createElement('label');
                    optionLabel.htmlFor = `q${number}option${index}`;
                    optionLabel.textContent = option;
                    
                    optionDiv.appendChild(optionInput);
                    optionDiv.appendChild(optionLabel);
                    optionsDiv.appendChild(optionDiv);
                });
            } else if (type === 'true-false') {
                ['True', 'False'].forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';
                    
                    const optionInput = document.createElement('input');
                    optionInput.type = 'radio';
                    optionInput.name = `question${number}`;
                    optionInput.id = `q${number}option${index}`;
                    optionInput.value = option;
                    if (index === questionContent.correctAnswer) {
                        optionInput.checked = true;
                        optionInput.dataset.correct = 'true';
                    }
                    
                    const optionLabel = document.createElement('label');
                    optionLabel.htmlFor = `q${number}option${index}`;
                    optionLabel.textContent = option;
                    
                    optionDiv.appendChild(optionInput);
                    optionDiv.appendChild(optionLabel);
                    optionsDiv.appendChild(optionDiv);
                });
            } else if (type === 'fill-in-blank') {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'option';
                
                const answerLabel = document.createElement('label');
                answerLabel.textContent = 'Correct Answer: ';
                
                const answerSpan = document.createElement('span');
                answerSpan.textContent = questionContent.answer;
                answerSpan.style.fontWeight = 'bold';
                
                answerLabel.appendChild(answerSpan);
                answerDiv.appendChild(answerLabel);
                optionsDiv.appendChild(answerDiv);
            }
            
            questionDiv.appendChild(optionsDiv);
            
            return questionDiv;
        }
        
        function generateAIQuestionContent(type) {
            // This simulates AI-generated questions based on PDF content
            // In a real implementation, these would come from an AI model that analyzed the PDF
            
            const pdfContent = [
                "The Pythagorean theorem states that in a right triangle, the square of the length of the hypotenuse equals the sum of the squares of the other two sides.",
                "Photosynthesis is the process by which green plants and some other organisms use sunlight to synthesize foods with the help of chlorophyll.",
                "The water cycle, also known as the hydrologic cycle, describes the continuous movement of water on, above and below the surface of the Earth.",
                "Gravity is a force that attracts a body toward the center of the earth, or toward any other physical body having mass.",
                "Mitosis is a process where a single cell divides into two identical daughter cells.",
                "The periodic table is a tabular arrangement of the chemical elements, ordered by their atomic number, electron configurations, and recurring chemical properties.",
                "The Renaissance was a period in European history marking the transition from the Middle Ages to modernity.",
                "An algorithm is a step-by-step procedure for solving a problem or accomplishing some end.",
                "Climate change refers to long-term shifts in temperatures and weather patterns, mainly caused by human activities."
            ];
            
            const randomContent = pdfContent[Math.floor(Math.random() * pdfContent.length)];
            
            if (type === 'multiple-choice') {
                return {
                    question: `Based on the document, ${randomContent.split('.')[0]}?`,
                    options: [
                        "This statement is correct and complete",
                        "This statement is partially correct",
                        "This statement is incorrect",
                        "This statement is not mentioned in the document"
                    ],
                    correctAnswer: 0
                };
            } else if (type === 'true-false') {
                return {
                    question: `True or False: ${randomContent}`,
                    correctAnswer: 0 // 0 = True, 1 = False
                };
            } else if (type === 'fill-in-blank') {
                const parts = randomContent.split(' ');
                const blankIndex = Math.floor(parts.length / 2);
                const blankWord = parts[blankIndex];
                parts[blankIndex] = '_________';
                
                return {
                    question: parts.join(' '),
                    answer: blankWord
                };
            }
        }
        
        function toggleEditMode(questionDiv) {
            const isEditMode = questionDiv.classList.contains('edit-mode');
            
            if (isEditMode) {
                // Save changes and exit edit mode
                const questionTextArea = questionDiv.querySelector('.edit-question');
                const questionText = questionDiv.querySelector('.question-text');
                questionText.textContent = questionTextArea.value;
                
                const type = questionDiv.dataset.type;
                
                if (type === 'multiple-choice' || type === 'true-false') {
                    const optionInputs = questionDiv.querySelectorAll('.edit-option');
                    const optionLabels = questionDiv.querySelectorAll('.option label');
                    
                    optionInputs.forEach((input, index) => {
                        if (optionLabels[index]) {
                            optionLabels[index].textContent = input.value;
                        }
                    });
                } else if (type === 'fill-in-blank') {
                    const answerInput = questionDiv.querySelector('.edit-answer');
                    const answerSpan = questionDiv.querySelector('.option span');
                    answerSpan.textContent = answerInput.value;
                }
                
                // Remove edit elements
                questionDiv.querySelectorAll('.edit-controls').forEach(el => el.remove());
                questionDiv.classList.remove('edit-mode');
            } else {
                // Enter edit mode
                questionDiv.classList.add('edit-mode');
                
                // Create edit controls for question
                const questionText = questionDiv.querySelector('.question-text');
                const editControls = document.createElement('div');
                editControls.className = 'edit-controls';
                
                const questionTextArea = document.createElement('textarea');
                questionTextArea.className = 'edit-question';
                questionTextArea.value = questionText.textContent;
                
                editControls.appendChild(questionTextArea);
                questionDiv.insertBefore(editControls, questionText.nextSibling);
                
                const type = questionDiv.dataset.type;
                
                if (type === 'multiple-choice' || type === 'true-false') {
                    // Create edit controls for options
                    const optionLabels = questionDiv.querySelectorAll('.option label');
                    optionLabels.forEach(label => {
                        const option = label.parentNode;
                        const optionInput = document.createElement('input');
                        optionInput.type = 'text';
                        optionInput.className = 'edit-option';
                        optionInput.value = label.textContent;
                        
                        const optionEditControls = document.createElement('div');
                        optionEditControls.className = 'edit-controls';
                        optionEditControls.appendChild(optionInput);
                        
                        option.appendChild(optionEditControls);
                    });
                } else if (type === 'fill-in-blank') {
                    // Create edit control for answer
                    const answerSpan = questionDiv.querySelector('.option span');
                    const option = answerSpan.parentNode.parentNode;
                    
                    const answerInput = document.createElement('input');
                    answerInput.type = 'text';
                    answerInput.className = 'edit-answer';
                    answerInput.value = answerSpan.textContent;
                    
                    const answerEditControls = document.createElement('div');
                    answerEditControls.className = 'edit-controls';
                    answerEditControls.appendChild(answerInput);
                    
                    option.appendChild(answerEditControls);
                }
            }
        }
        
        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-container');
            questions.forEach((question, index) => {
                const number = index + 1;
                question.dataset.number = number;
                
                const questionHeader = question.querySelector('h3');
                questionHeader.textContent = `Question ${number}`;
                
                // Preserve the question type span
                const typeSpan = question.querySelector('.question-type');
                if (typeSpan) {
                    questionHeader.appendChild(typeSpan);
                }
                
                // Update radio button names
                const radioButtons = question.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(radio => {
                    radio.name = `question${number}`;
                    radio.id = radio.id.replace(/q\d+/, `q${number}`);
                });
                
                // Update labels
                const labels = question.querySelectorAll('label');
                labels.forEach(label => {
                    if (label.htmlFor && label.htmlFor.startsWith('q')) {
                        label.htmlFor = label.htmlFor.replace(/q\d+/, `q${number}`);
                    }
                });
            });
            
            // Update question count
            document.getElementById('questionCount').textContent = questions.length;
        }
        
        function uploadTest() {
            // Collect all questions and options
            const questions = [];
            const questionElements = document.querySelectorAll('.question-container');
            
            questionElements.forEach(questionEl => {
                const questionNumber = questionEl.dataset.number;
                const questionType = questionEl.dataset.type;
                const questionText = questionEl.querySelector('.question-text').textContent;
                
                let questionData = {
                    number: parseInt(questionNumber),
                    type: questionType,
                    text: questionText
                };
                
                if (questionType === 'multiple-choice') {
                    const options = [];
                    let correctAnswer = null;
                    
                    questionEl.querySelectorAll('.option label').forEach((label, index) => {
                        options.push(label.textContent);
                    });
                    
                    questionEl.querySelectorAll('.option input').forEach((input, index) => {
                        if (input.checked || input.dataset.correct === 'true') {
                            correctAnswer = index;
                        }
                    });
                    
                    questionData.options = options;
                    questionData.correctAnswer = correctAnswer !== null ? correctAnswer : 0;
                } else if (questionType === 'true-false') {
                    let correctAnswer = 0; // Default to True
                    
                    questionEl.querySelectorAll('.option input').forEach((input, index) => {
                        if (input.checked || input.dataset.correct === 'true') {
                            correctAnswer = index;
                        }
                    });
                    
                    questionData.correctAnswer = correctAnswer;
                } else if (questionType === 'fill-in-blank') {
                    const answerSpan = questionEl.querySelector('.option span');
                    questionData.answer = answerSpan.textContent;
                }
                
                questions.push(questionData);
            });
            
            // Get test data
            const testData = JSON.parse(sessionStorage.getItem('newTestData') || '{}');
            
            // Combine test data with questions
            const completeTest = {
                name: testData.testName,
                duration: parseInt(testData.duration),
                questionCount: questions.length,
                questions: questions,
                createdAt: new Date().toISOString(),
                active: true
            };
            
            console.log('Test data to be uploaded:', completeTest);
            
            // In a real implementation, this would make an AJAX request to the server
            alert(`Test "${completeTest.name}" has been created successfully with ${completeTest.questionCount} AI-generated questions and is now available for students.`);
            
            // Redirect to staff dashboard
            window.location.href = '/staff/dashboard';
        }
    </script>
</body>
</html>
