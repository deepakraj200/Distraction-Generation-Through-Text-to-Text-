<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --danger: #f72585;
      --success: #4cc9f0;
      --light: #f8f9fa;
      --gray: #6c757d;
      --dark: #212529;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(to right, #f5f7fb, #e6ecff);
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    a {
      text-decoration: none;
      color: var(--primary);
      font-weight: 500;
    }

    h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--dark);
    }

    .result-summary {
      text-align: center;
      margin-bottom: 2rem;
      font-size: 16px;
    }

    .result-summary h3 {
      margin-bottom: 0.5rem;
      font-size: 22px;
      color: var(--primary);
    }

    .result-summary p {
      margin: 0.3rem 0;
      color: var(--gray);
    }

    #result-chart-container {
      max-width: 400px;
      margin: 2rem auto;
    }

    .result-item {
      padding: 1.5rem;
      border-radius: 12px;
      background: #f9f9f9;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .result-item.correct {
      border-left: 6px solid #27ae60;
    }

    .result-item.incorrect {
      border-left: 6px solid #e74c3c;
    }

    .result-item h4 {
      margin-bottom: 0.5rem;
      font-size: 16px;
    }

    .result-item p {
      margin: 0.3rem 0;
    }

    .result-status {
      font-weight: bold;
      color: var(--gray);
    }

    .result-status::before {
      content: "â€¢ ";
    }

    .correct .result-status {
      color: #27ae60;
    }

    .incorrect .result-status {
      color: #e74c3c;
    }

    .loading-text {
      text-align: center;
      color: var(--gray);
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/dashboard">&larr; Back to Dashboard</a>
    <h2>Test Results</h2>

    <div id="result-summary" class="result-summary">
      <p class="loading-text">Loading results...</p>
    </div>

    <div id="result-chart-container">
      <canvas id="resultChart"></canvas>
    </div>

    <div id="result-details">
      <!-- Detailed answers will appear here -->
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const urlParams = new URLSearchParams(window.location.search);
      const resultId = urlParams.get('id');

      if (!resultId) {
        document.getElementById('result-summary').innerHTML = '<p>Error: No result ID provided</p>';
        return;
      }

      fetch(`/get_result/${resultId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayResults(data.result);
          } else {
            document.getElementById('result-summary').innerHTML = `<p>Error: ${data.message}</p>`;
          }
        })
        .catch(err => {
          console.error(err);
          document.getElementById('result-summary').innerHTML = '<p>Error loading results.</p>';
        });

      function displayResults(result) {
        const summary = document.getElementById('result-summary');
        summary.innerHTML = `
          <h3>${result.testName}</h3>
          <p><strong>Score:</strong> ${result.scorePercent}%</p>
          <p><strong>Correct:</strong> ${result.correctCount} / ${result.totalQuestions}</p>
          <p><strong>Date:</strong> ${new Date(result.date).toLocaleString()}</p>
        `;

        // Chart
        const ctx = document.getElementById('resultChart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Correct', 'Incorrect'],
            datasets: [{
              data: [result.correctCount, result.totalQuestions - result.correctCount],
              backgroundColor: ['#27ae60', '#e74c3c'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: {
                display: true,
                text: 'Your Performance'
              }
            }
          }
        });

        // Details
        const detailsDiv = document.getElementById('result-details');
        detailsDiv.innerHTML = '<h3 style="margin-top:2rem; margin-bottom:1rem;">Answer Breakdown</h3>';
        result.answers.forEach((ans, idx) => {
          const isCorrect = ans.selected === ans.correct;
          const div = document.createElement('div');
          div.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
          div.innerHTML = `
            <h4>Q${idx + 1}: ${ans.question}</h4>
            <p><strong>Your Answer:</strong> ${ans.selected || 'Not answered'}</p>
            <p><strong>Correct Answer:</strong> ${ans.correct}</p>
            <p class="result-status">${isCorrect ? 'Correct' : 'Incorrect'}</p>
          `;
          detailsDiv.appendChild(div);
        });
      }
    });
  </script>
</body>
</html>
